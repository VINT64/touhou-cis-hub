
<div id="list-container">


 <script>


function Normalise(string) {
    return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
}

function addText(block, text){
	block.appendChild(document.createTextNode(text));
}
function myNewBlock(type, cl){
	var ret = document.createElement(type);
	if (cl !== undefined)
		ret.className = cl;
	return ret;
}
function myNewText(type, text){
	var ret = document.createElement(type);
	if (text !== undefined)
		addText(ret, text);
	return ret;
}

function parse_link(link){
	var left_part;
	if (link.description == '' ) 
	switch(link.source){
		case 'vk':
			left_part = 'ВК';
			break;
		case 'deviantart':
			left_part = 'DeviantArt';
			break;
		case 'discord':
		case 'youtube':
		case 'telegram':
		case 'tumblr':
			left_part = Normalise(link.source);
			break;
		default:
			left_part = 'Ссылка';
			break;
	}
	else
		left_part = link.description;
	var ret = myNewText('p', left_part + ': ');
	var l = myNewText('a', link.url);
	l.setAttribute('href', link.url);
	ret.appendChild(l);
	return ret;
}
function parse_entry(entry){
	var ret = myNewBlock('div', 'list-entry');
	var title = myNewText('h2', entry.title);
	ret.appendChild(title);
	var desc = myNewText('p', entry.description);
	ret.appendChild(desc);
	if (entry.tags.length > 0){
		var tags = 'Теги: ';
		//TODO: interactive
		entry.tags.forEach(function(item, i, arr){
			if (i != 0)
				tags+= ', ';
			tags += item;
		});
		ret.appendChild(myNewText('p', tags));
	}
	entry.links_list.forEach(function(item, i, arr){
		var l = parse_link(item);
		ret.appendChild(l);
	});
	return ret;
}
function parse_section(section){
	var ret = myNewBlock('div', 'list-section');
	ret.id = 'section';
	var h = myNewText('h1', section.name);
	ret.appendChild(h);
	section.entries_list.forEach(function(item, i, arr) {
		ret.appendChild(parse_entry(item));
	});
	return ret;
}
function parse_list(list){
	var body = document.getElementById('list-container');
	var h = myNewBlock('div', 'list-desc');
	h.appendChild(myNewText('p', 'Ссылки на сообщества по Touhou Project в СНГ сегменте. Touhou СНГ Хаб©'));
	body.appendChild(h);
	var d = myNewBlock('div', 'list-date');
	var dd = myNewText('p', 'Список на ' + list.date);
	d.appendChild(dd);
	body.appendChild(d);
	var menu = myNewBlock('ol', 'list-menu');
	var section;
	list.sections_list.forEach(function(item, i, arr) {
		var li = myNewBlock('li');
		var a = myNewText('a', item.name);
		a.setAttribute('href', '#');
		var l = parse_section(item);
		if (section === undefined)
			section = l;
		a.addEventListener('click', function() {
			body.replaceChild(l, document.getElementById('section'));
		});
		li.appendChild(a);
		menu.appendChild(li);
	});
	
	body.appendChild(menu);
	body.appendChild(section);
}

function loadJSON() {   
    var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
    xobj.open('GET', '/links_lists/ll_latest.json', true);
    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4 && xobj.status == "200")
            parse_list(JSON.parse(xobj.responseText));
		else{
		}
    };
    xobj.send(null);  
}
window.addEventListener('DOMContentLoaded', function() {
	loadJSON();
});
  </script>

</div>
